# 1. 链接器

Rust 编译时因为 borrow checker 太严格，或者泛型展开太多，导致编译慢。但最大的瓶颈其实在最后一步，即链接。

编译器将代码翻译成一堆零散的机器码片段，链接器负责将这些片段拼接成最终的可执行文件。

为提高编译速度，需要更换更现代的链接器

## 1.1 Linux

```bash
# Ubuntu/Debian
sudo apt install mold

# Redhat/CentOS
sudo yum install mold

# Arch Linux
sudo pacman -S mold
```

在项目根目录创建 `.cargo/config.toml` 文件，增加如下配置：

```toml
[target.x86_64-unknown-linux-gnu]
linker = "/usr/bin/clang"
rustflags = ["-C", "link-arg=--ld-path=/usr/bin/mold"]
```



## 1.2 MacOS

```bash
# macOS用sold（mold的Mac版）
brew install sold
```

在项目根目录创建 `.cargo/config.toml` 文件，增加如下配置：

```toml
[target.aarch64-apple-darwin]
rustflags = ["-C", "link-arg=-fuse-ld=/opt/homebrew/bin/sold"]

[target.x86_64-apple-darwin]
rustflags = ["-C", "link-arg=-fuse-ld=/usr/local/bin/sold"]
```



## 1.3 跨平台通用

如果使用 Windows 或懒得装 mold，lld 也是个好选择，它是 LLVM 项目的链接器，速度虽然没有 mold 快，但比默认的快的多

在项目根目录创建 `.cargo/config.toml` 文件，增加如下配置：

```toml
[build]
rustflags = ["-C", "link-arg=-fuse-ld=lld"]
```

Rust 1.90 后，将默认使用 rust-lld，不需要再手动配置



# 2. sccache

sccache 是一个由 Mozilla 开发的开源**编译器缓存工具**，它像一个“编译器包装器”，通过缓存编译结果来显著加速 C/C++、Rust 甚至 CUDA 等语言的编译过程，避免重复编译，支持将缓存存储在本地磁盘或云存储（如 S3），并提供分布式编译支持，尤其适合大型项目和 CI/CD 环境。

```bash
# 安装
cargo install sccache

# 配置
vi ~/.cargo/config.toml
[build]
incremental = true                        # 增量编译
rustflags = ["-C", "codegen-units=16"]    # 每个 crate 分成称为代码生成单元 (codegen units) 的块进行编译，这个有16个线程
rustc-wrapper = "sccache"

# 启用环境变量 (可选)
export RUST_WRAPPER="sccache"
```



常见陷阱：

- CI 构建：在 CI 环境环境中禁用增量构建。使用 `CARGO_INCREMENTAL=0` 来获得确定性的输出
- Release 模式：考虑将代码生成单元 (codegen unit) 减少到 1-4 个，以实现最大程度的优化
- 磁盘空间：增量构建和 sccache 会随着时间推移占用大量空间。可使用 `cargo clean` 和 `sccache --zero-stats` 偶尔进行清理







