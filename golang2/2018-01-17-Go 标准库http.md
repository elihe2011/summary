---
layout: post
title:  Go标准库 http
date:   2018-01-17 12:11:18
comments: true
photos: 
tags: 
  - go
categories: Golang
---

# 1. 客户端

Http Client:

- http.GET(url) 直接发起请求
- http.Client{} 控制请求头部等
- httputil 简化工作

示例：

```go
func main() {
	// 1. 直接发起请求
	//resp, err := http.Get("https://baidu.com")

	// 2. 控制请求头
	req, err := http.NewRequest(
		http.MethodGet,
		"http://www.baidu.com", nil)
	req.Header.Add("User-Agent",
		"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1")
	//resp, err := http.DefaultClient.Do(req)

	// 3. 检测是否重定向
	client := http.Client{
		CheckRedirect: func(req *http.Request, via []*http.Request) error {
			fmt.Println("Redirect:", req)
			return nil
		},
	}
	resp, err := client.Do(req)

	if err != nil {
		panic(err)
	}
	defer resp.Body.Close()

	content, err := httputil.DumpResponse(resp, true)
	if err != nil {
		panic(err)
	}

	fmt.Printf("%s", content)
}
```

# 2. 服务端

## 2.1 handler函数

```go
func SignupHandler(w http.ResponseWriter, r *http.Request) {
	if r.Method == http.MethodGet {
		data, err := ioutil.ReadFile("./static/view/signup.html")
		if err != nil {
			w.WriteHeader(http.StatusInternalServerError)
			return
		}

		w.Write(data)
	} else {
		r.ParseForm()  // 必须的
		username := r.Form.Get("username")
		password := r.Form.Get("password")

		if len(username) < 3 || len(password) < 5 {
			w.Write([]byte("Invalid parameter"))
			return
		}

		enc_pwd := util.Sha1([]byte(password + pwd_salt))
		ret := db.UserSignup(username, enc_pwd)
		if ret {
			w.Write([]byte("SUCCESS"))
		} else {
			w.Write([]byte("FAILED"))
		}
	}
}
```

## 2.2 中间件

```go
func HTTPInterceptor(h http.HandlerFunc) http.HandlerFunc {
	return http.HandlerFunc(
		func(w http.ResponseWriter, r *http.Request) {
			r.ParseForm()
			username := r.Form.Get("username")
			token := r.Form.Get("token")

			if len(username) < 3 || !IsTokenValid(token) {
				w.WriteHeader(http.StatusForbidden)
				return
			}

			h(w, r)
		})
}
```

## 2.3 启动服务

```go
func main() {
	// 静态文件
	path, _ := os.Getwd()
	path = filepath.Join(path, "static")
	http.Handle("/static/", http.StripPrefix("/static/", http.FileServer(http.Dir(path))))

	// 路由和中间件
	http.HandleFunc("/user/signup", handler.SignupHandler)
	http.HandleFunc("/user/info", handler.HTTPInterceptor(handler.UserInfoHandler))

	err := http.ListenAndServe(":8080", nil)
	if err != nil {
		log.Fatalf("Failed to start server: %v", err)
	}
}
```


# 3. http服务器性能分析

- `import _ "net/http/pprof`
- 访问`/debug/pprof/`
- 使用`go tool pprof`分析性能


```go
import (
	"log"
	"net/http"
	_ "net/http/pprof"
	"os"
	...
)
```

查看性能：

http://localhost:8080/debug/pprof/

go tool pprof http://localhost:8080/debug/pprof/profile

